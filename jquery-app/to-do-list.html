<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="quitbutton" content="visibility:visible;" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<!--<link rel="stylesheet" href="./styles/jquery.mobile-1.1.1.css" />-->
		<link rel="stylesheet" href="./styles/e-midwife-custom-theme.css" />
		<link rel="stylesheet" href="./styles/jquery.mobile.structure-1.1.1.min.css" />
		<!--<link type="text/css" href="./styles/jqm-datebox.min.css" rel="stylesheet" />
		<link type="text/css" href="./styles/jquery.mobile.simple.css" rel="stylesheet" />
		<link type="text/css" href="./styles/demos.css" rel="stylesheet" /> -->

		<script src="./libs/jquery-1.8.2.js" type="text/javascript" charset="utf-8"></script>
		<script src="./libs/jquery.mobile-1.1.1.js" type="text/javascript" charset="utf-8"></script>
		<script src="./libs/knockout/knockout-2.1.0pre.js" type="text/javascript" charset="utf-8"></script>
		<!--<script src="./src/bindings/to-do-list.js" type="text/javascript" charset="utf-8"></script>-->

		<script>
			var html5rocks = {};
			html5rocks.webdb = {};
			html5rocks.webdb.db = null;

			html5rocks.webdb.open = function() {
				var dbSize = 5 * 1024 * 1024;
				// 5MB
				html5rocks.webdb.db = openDatabase("Todo", "1.0", "Todo manager", dbSize);
			}

			html5rocks.webdb.createTable = function() {
				var db = html5rocks.webdb.db;
				db.transaction(function(tx) {
					tx.executeSql("CREATE TABLE IF NOT EXISTS todo(ID INTEGER PRIMARY KEY ASC, todo TEXT, added_on DATETIME)", []);
				});
			}

			html5rocks.webdb.addTodo = function(todoText) {
				var db = html5rocks.webdb.db;
				db.transaction(function(tx) {
					var addedOn = new Date();
					tx.executeSql("INSERT INTO todo(todo, added_on) VALUES (?,?)", [todoText, addedOn], html5rocks.webdb.onSuccess, html5rocks.webdb.onError);
				});
			}

			html5rocks.webdb.onError = function(tx, e) {
				alert("There has been an error: " + e.message);
			}

			html5rocks.webdb.onSuccess = function(tx, r) {
				// re-render the data.
				html5rocks.webdb.getAllTodoItems(loadTodoItems);
			}

			html5rocks.webdb.getAllTodoItems = function(renderFunc) {
				var db = html5rocks.webdb.db;
				db.transaction(function(tx) {
					tx.executeSql("SELECT * FROM todo", [], renderFunc, html5rocks.webdb.onError);
				});
			}

			html5rocks.webdb.deleteTodo = function(id) {
				var db = html5rocks.webdb.db;
				db.transaction(function(tx) {
					tx.executeSql("DELETE FROM todo WHERE ID=?", [id], html5rocks.webdb.onSuccess, html5rocks.webdb.onError);
				});
			}
			function loadTodoItems(tx, rs) {
				var rowOutput = "";
				var todoItems = document.getElementById("todoItems");
				for (var i = 0; i < rs.rows.length; i++) {
					rowOutput += renderTodo(rs.rows.item(i));
				}

				todoItems.innerHTML = rowOutput;
			}

			function renderTodo(row) {
				return "<li data-theme='a' data-role='listview' data-inset='true'>" + row.todo + " [<a href='javascript:void(0);' data-role='button' onclick='html5rocks.webdb.deleteTodo(" + row.ID + ");'>Delete</a>]</li>";
			}

			function init() {
				html5rocks.webdb.open();
				html5rocks.webdb.createTable();
				html5rocks.webdb.getAllTodoItems(loadTodoItems);
			}

			function addTodo() {
				var todo = document.getElementById("todo");
				html5rocks.webdb.addTodo(todo.value);
				todo.value = "";
			}
		</script>
	</head>

	<body onload="init();">
		<div data-role="page">

			<div data-role="header" data-position="fixed">
				<a href="" data-rel="back" data-theme="c">ආපසු</a>
				<h1>e-medic</h1>
			</div><!-- /header -->

			<div data-role="content">
				<input type="text" id="todo" name="todo" placeholder="What do you need to do?" style="width: 100%;" data-bind="value:todoItem"/>
				<a data-bind="click:$root.addTask" data-role="button">Add</a>
				<ul id="todoItems" data-role="listview"></ul>
				<div data-role="footer" data-position="fixed">
					<center>
						University of Peradeniya
					</center>
				</div>
			</div><!-- /page -->
			<script type="text/javascript">
				function TaskListViewModel() {
					var self = this;
					this.todoItem = ko.observable();
					this.addTask = function() {
						html5rocks.webdb.addTodo(self.todoItem());
						self.todoItem('');
					};
				}
				ko.applyBindings(new TaskListViewModel());
			</script>
	</body>
</html>

